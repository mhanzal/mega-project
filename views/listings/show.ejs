<% layout('layouts/boilerplate.ejs') %>

    <body>
        <div class="container my-5">
            <h3 class="text-center mb-4">
                <%= listing.title %>
            </h3>

            <div class="row justify-content-center">
                <div class="col-lg-6">

                    <!-- Listing Card -->
                    <div class="card shadow-lg border-0 rounded-4 mb-5">
                        <img src="<%= listing.image.url %>" class="card-img-top rounded-top-4"
                            style="object-fit: cover; height: 28rem;" alt="<%= listing.title %>">
                        <div class="card-body">
                            <p class="card-text">
                                <b>Owned by </b>
                                <%= listing.owner?.username || "this is not Owner" %>
                            </p>

                            <p class="card-text text-muted">
                                <%= listing.description %>
                            </p>
                            <hr>
                            <p><strong>Price:</strong> ‚Çπ<%= listing.price.toLocaleString('en-US') %>
                            </p>
                            <p><strong>Location:</strong>
                                <%= listing.location %>, <%= listing.country %>
                            </p>
                        </div>

                        <% if(curUser && listing.owner._id.equals(curUser._id)) {%>
                            <div class="card-footer bg-transparent border-0 d-flex justify-content-between">
                                <a href="/listings/<%= listing._id %>/edit"
                                    class="btn btn-primary px-4 fw-semibold">Edit</a>
                                <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST"
                                    onsubmit="return confirm('Are you sure you want to delete this listing?');">
                                    <button class="btn btn-danger px-4 fw-semibold">Delete</button>
                                </form>
                            </div>
                            <%}%>

                    </div>

                    <hr>

                    <!-- Error Message -->

                    <!-- Review Form -->

                    <div class="card shadow-sm border-0 rounded-4 p-4 mb-5">
                        <% if (curUser) { %>
                            <h4 class="text-center mb-4 fw-semibold">Leave a Review</h4>

                            <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate>

                                <fieldset class="starability-slot">
                                    <legend for="comment" class="form-label fw-semibold">Rating</legend>
                                    <input type="radio" id="no-rate" class="input-no-rate" name="reviews[rating]"
                                        value="1" checked aria-label="No rating." />
                                    <input type="radio" id="first-rate1" name="reviews[rating]" value="1" required />
                                    <label for="first-rate1" title="Terrible">1 star</label>
                                    <input type="radio" id="first-rate2" name="reviews[rating]" value="2" />
                                    <label for="first-rate2" title="Not good">2 stars</label>
                                    <input type="radio" id="first-rate3" name="reviews[rating]" value="3" />
                                    <label for="first-rate3" title="Average">3 stars</label>
                                    <input type="radio" id="first-rate4" name="reviews[rating]" value="4" />
                                    <label for="first-rate4" title="Very good">4 stars</label>
                                    <input type="radio" id="first-rate5" name="reviews[rating]" value="5" />
                                    <label for="first-rate5" title="Amazing">5 stars</label>
                                </fieldset>

                                <div class="mb-3 mt-4">
                                    <legend for="comment" class="form-label fw-semibold">Comment</legend>
                                    <textarea name="reviews[comments]" id="comment" rows="4" class="form-control"
                                        placeholder="Write your thoughts here..." minlength="5" required></textarea>
                                    <div class="invalid-feedback">Please write at least 5 characters.</div>
                                </div>

                                <div class="text-center">
                                    <button type="submit" class="btn btn-success px-5 fw-semibold">Submit
                                        Review</button>
                                </div>
                            </form>
                            <% } else { %>
                                <div class="alert alert-danger alert-dismissible text-center mt-3">
                                    Please <a href="/login" class="fw-bold">log in</a> to leave a review.
                                </div>
                                <% } %>
                    </div>


                    <hr>

                    <div>

                        <div class="container mt-5 w-100 h-100">

                            <h3 class="text-center mb-4 fw-semibold text-primary">All Reviews</h3>

                            <div class="row">
                                <% for (let review of listing.reviews) { %>
                                    <div class="col-md-6 mb-4">
                                        <div class="border rounded-4 shadow-sm p-4 h-100">

                                            <p class="mb-0 text-dark fw-bold mb-3">
                                                @<%= review.author.username %>
                                            </p>

                                            <div class="d-flex justify-content-between align-items-center mb-2">

                                                <p class="starability-result" data-rating="<%= review.rating %>">
                                                    <!-- Rated: 3 stars -->
                                                </p>
                                            </div>

                                            <p class="mb-0 text-secondary fst-italic">
                                                ‚Äú<%= review.comments %>‚Äù
                                            </p>

                                            <form
                                                action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                                                method="POST">
                                                <button
                                                    class="btn btn-danger mt-3 px-4 fw-semibold w-100">Delete</button>
                                            </form>
                                        </div>
                                    </div>
                                    <% } %>
                            </div>
                        </div>

                    </div>
    <div id="map" style="height: 400px; width: 100%; border-radius: 10px;" class="mb-5"></div>

                </div>

            </div>
        </div>
        </div>

      
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
   
  <script>
    async function showMap() {
      const location = `<%= listing.location %>, <%= listing.country %>`;

      // üåê Get coordinates using OpenStreetMap Nominatim API
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(location)}`);
      const data = await res.json();

      if (!data || data.length === 0) {
        document.getElementById('map').innerHTML =
          '<p class="text-center text-danger">Location not found on the map.</p>';
        return;
      }

      const lat = parseFloat(data[0].lat);
      const lon = parseFloat(data[0].lon);

      // Initialize Leaflet Map
      const map = L.map('map').setView([lat, lon], 13);

      // Add OpenStreetMap Tiles (English)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
      }).addTo(map);

      // Create Google Maps clickable link
      const googleLink = `https://www.google.com/maps?q=${lat},${lon}`;

      // Marker + Popup with clickable link
      const marker = L.marker([lat, lon]).addTo(map);
      marker.bindPopup(`
        <b><%= listing.title %></b><br>
        <%= listing.location %>, <%= listing.country %><br>
        <a href="${googleLink}" target="_blank" style="color: #007BFF; text-decoration: underline;">
          View on Google Maps
        </a>
      `).openPopup();

      // On marker click, open Google Maps directly
      marker.on('click', () => {
        window.open(googleLink, '_blank');
      });
    }

    showMap();
  </script>

        <script>
                (() => {
                    'use strict'
                    const forms = document.querySelectorAll('form')
                    Array.from(forms).forEach(form => {
                        form.addEventListener('submit', event => {
                            if (!form.checkValidity()) {
                                event.preventDefault()
                                event.stopPropagation()
                            }
                            form.classList.add('was-validated')
                        }, false)
                    })
                })()
        </script>
    </body>